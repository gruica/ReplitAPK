name: Build Signed Android APK

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build Signed APK
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Set up Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Cache npm dependencies
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-npm-

    - name: Install dependencies with retry
      run: |
        for i in 1 2 3; do
          npm ci --legacy-peer-deps && break || sleep 10
        done

    - name: Build web application
      run: npm run build
      env:
        NODE_ENV: production

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Decode keystore from base64
      run: |
        echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > android/app/servis-todosijevic-release.keystore
        echo "âœ… Keystore dekodovan uspeÅ¡no"
        ls -lh android/app/servis-todosijevic-release.keystore

    - name: Make gradlew executable
      run: chmod +x android/gradlew

    - name: Sync Capacitor with Android
      run: npx cap sync android

    - name: Build and Sign Release APK
      env:
        KEYSTORE_ALIAS: ${{ secrets.KEYSTORE_ALIAS }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      run: |
        cd android
        echo "ğŸ—ï¸ Kompajliranje i potpisivanje APK-a..."
        for i in 1 2 3; do
          ./gradlew assembleRelease --no-daemon --stacktrace && break || sleep 15
        done
        echo "âœ… APK uspeÅ¡no napravljen i potpisan!"

    - name: Verify APK signature
      run: |
        echo "ğŸ” Provera potpisa APK-a..."
        jarsigner -verify -verbose -certs android/app/build/outputs/apk/release/app-release.apk

    - name: Upload Signed APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: servis-todosijevic-signed-apk-v${{ github.run_number }}
        path: android/app/build/outputs/apk/release/app-release.apk
        retention-days: 90

    - name: Create GitHub Release
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}', github.run_number) }}
        name: Servis TodosijeviÄ‡ v${{ github.run_number }}
        body: |
          ğŸ“± **Servis TodosijeviÄ‡ - ZvaniÄna Android Aplikacija**
          
          **Verzija:** v${{ github.run_number }}
          **Build datum:** ${{ github.event.head_commit.timestamp }}
          **Git commit:** ${{ github.sha }}
          
          ## ğŸ“¥ Instalacija
          1. Preuzmite `app-release.apk` fajl ispod
          2. Na Android telefonu omoguÄ‡ite **"Instalacija aplikacija iz nepoznatih izvora"**:
             - PodeÅ¡avanja â†’ Bezbednost â†’ Nepoznati izvori
          3. Otvorite preuzeti APK fajl i instalirajte
          
          ## ğŸ”§ Funkcionalnosti
          - âœ… Kompletna administracija servisa
          - âœ… Offline rad mobilne aplikacije
          - âœ… Profesionalni mobilni interfejs
          - âœ… Potpisana i sigurna APK
          - âœ… Automatsko aÅ¾uriranje podataka
          
          ## ğŸ” Sigurnost
          - APK je digitalno potpisan sa zvaniÄnim keystore-om
          - Sigurna HTTPS komunikacija sa serverom
          - Enkripcija podataka
          
          ## ğŸ“ PodrÅ¡ka
          Za pitanja i pomoÄ‡: jelena@frigosistemtodosijevic.com
        files: android/app/build/outputs/apk/release/app-release.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
