name: Build Signed Android APK

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build Signed APK
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Set up Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Cache npm dependencies
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.os }}-npm-

    - name: Install dependencies with retry
      run: |
        for i in 1 2 3; do
          npm ci --legacy-peer-deps && break || sleep 10
        done

    - name: Build web application
      run: npm run build
      env:
        NODE_ENV: production

    - name: Set up Android SDK
      uses: android-actions/setup-android@v3

    - name: Decode keystore from base64
      run: |
        echo "${{ secrets.KEYSTORE_FILE }}" | base64 --decode > android/app/android-release.keystore
        echo "âœ… Keystore dekodovan uspeÅ¡no"
        ls -lh android/app/android-release.keystore

    - name: Make gradlew executable
      run: chmod +x android/gradlew

    - name: Sync Capacitor with Android
      run: npx cap sync android

    - name: Validate secrets
      run: |
        echo "ğŸ” Validacija GitHub Secrets..."
        if [ -z "${{ secrets.KEYSTORE_ALIAS }}" ]; then
          echo "âŒ GREÅ KA: KEYSTORE_ALIAS secret nije postavljen!"
          exit 1
        fi
        if [ -z "${{ secrets.KEYSTORE_PASSWORD }}" ]; then
          echo "âŒ GREÅ KA: KEYSTORE_PASSWORD secret nije postavljen!"
          exit 1
        fi
        if [ -z "${{ secrets.KEYSTORE_FILE }}" ]; then
          echo "âŒ GREÅ KA: KEYSTORE_FILE secret nije postavljen!"
          exit 1
        fi
        echo "âœ… Svi secrets su prisutni"

    - name: Build and Sign Release APK
      env:
        KEYSTORE_ALIAS: ${{ secrets.KEYSTORE_ALIAS }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      run: |
        cd android
        echo "ğŸ—ï¸ Kompajliranje i potpisivanje APK-a..."
        echo ""
        echo "ğŸ“‹ Build informacije:"
        echo "  - KEYSTORE_ALIAS: ${KEYSTORE_ALIAS:0:3}***"
        echo "  - KEYSTORE_PASSWORD length: ${#KEYSTORE_PASSWORD}"
        echo "  - Keystore file:"
        ls -lh app/android-release.keystore
        echo ""
        
        set -e
        
        echo "ğŸ”¨ Pokretanje Gradle build-a..."
        ./gradlew assembleRelease --no-daemon --stacktrace 2>&1 | tee gradle-build.log
        
        BUILD_EXIT_CODE=${PIPESTATUS[0]}
        if [ $BUILD_EXIT_CODE -ne 0 ]; then
          echo ""
          echo "âŒ ============================================"
          echo "âŒ GRADLE BUILD FAIL-OVAO!"
          echo "âŒ ============================================"
          echo ""
          echo "ğŸ“„ Poslednje linije build log-a:"
          tail -100 gradle-build.log
          echo ""
          echo "ğŸ’¡ Proveri da li su GitHub Secrets pravilno postavljeni:"
          echo "   - KEYSTORE_ALIAS"
          echo "   - KEYSTORE_PASSWORD"
          echo "   - KEYSTORE_FILE (mora biti base64 enkodovan)"
          exit $BUILD_EXIT_CODE
        fi
        
        echo ""
        echo "ğŸ“ Proveravanje output foldera..."
        ls -lR app/build/outputs/apk/ || echo "âš ï¸ Folder ne postoji"
        
        if [ ! -f "app/build/outputs/apk/release/app-release.apk" ]; then
          echo ""
          echo "âŒ ============================================"
          echo "âŒ APK FAJL NIJE KREIRAN!"
          echo "âŒ ============================================"
          echo ""
          echo "ğŸ“„ Build je proÅ¡ao ali APK nije napravljen. Build log:"
          tail -150 gradle-build.log
          exit 1
        fi
        
        echo ""
        echo "âœ… ============================================"
        echo "âœ… APK USPEÅ NO NAPRAVLJEN I POTPISAN!"
        echo "âœ… ============================================"
        echo ""
        ls -lh app/build/outputs/apk/release/app-release.apk

    - name: Upload Gradle build log
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: gradle-build-log-${{ github.run_number }}
        path: android/gradle-build.log
        retention-days: 30

    - name: Verify APK signature
      if: success()
      run: |
        echo "ğŸ” Provera potpisa APK-a..."
        jarsigner -verify -verbose -certs android/app/build/outputs/apk/release/app-release.apk
        
        echo ""
        echo "âœ… APK potpis je validan!"

    - name: Upload Signed APK Artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: servis-todosijevic-signed-apk-v${{ github.run_number }}
        path: android/app/build/outputs/apk/release/app-release.apk
        retention-days: 90

    - name: Create GitHub Release
      if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}', github.run_number) }}
        name: Servis TodosijeviÄ‡ v${{ github.run_number }}
        body: |
          ğŸ“± **Servis TodosijeviÄ‡ - ZvaniÄna Android Aplikacija**
          
          **Verzija:** v${{ github.run_number }}
          **Build datum:** ${{ github.event.head_commit.timestamp }}
          **Git commit:** ${{ github.sha }}
          
          ## ğŸ“¥ Instalacija
          1. Preuzmite `app-release.apk` fajl ispod
          2. Na Android telefonu omoguÄ‡ite **"Instalacija aplikacija iz nepoznatih izvora"**:
             - PodeÅ¡avanja â†’ Bezbednost â†’ Nepoznati izvori
          3. Otvorite preuzeti APK fajl i instalirajte
          
          ## ğŸ”§ Funkcionalnosti
          - âœ… Kompletna administracija servisa
          - âœ… Offline rad mobilne aplikacije
          - âœ… Profesionalni mobilni interfejs
          - âœ… Potpisana i sigurna APK
          - âœ… Automatsko aÅ¾uriranje podataka
          
          ## ğŸ” Sigurnost
          - APK je digitalno potpisan sa zvaniÄnim keystore-om
          - Sigurna HTTPS komunikacija sa serverom
          - Enkripcija podataka
          
          ## ğŸ“ PodrÅ¡ka
          Za pitanja i pomoÄ‡: jelena@frigosistemtodosijevic.com
        files: android/app/build/outputs/apk/release/app-release.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
